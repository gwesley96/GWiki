\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gwiki-links}[2025/12/08 v3.0 GWiki Cross-Document PDF Linking]

%% ============================================================================
%% GWIKI LINKS v3 - CROSS-DOCUMENT PDF LINKING
%%
%% Design principles:
%%   - Filename = ID (no manual ID assignment)
%%   - Single \wref{name} command for everything
%%   - Links between separate PDFs using \href{file.pdf}
%%   - Click a link -> opens the other PDF
%% ============================================================================

\RequirePackage{xparse}
\RequirePackage{xstring}
\RequirePackage{hyperref}
\RequirePackage{xr-hyper}  % Cross-document references
\RequirePackage{pgffor}
\RequirePackage{filemod}
\RequirePackage{datetime2}
\RequirePackage{etoolbox}
\RequirePackage{array}

\makeatletter

%% ----------------------------------------------------------------------------
%% AUTO ID FROM FILENAME
%% ----------------------------------------------------------------------------
\newcommand{\gwiki@id}{\jobname}

%% Create anchor at document start (for internal refs)
\AtBeginDocument{%
  \hypertarget{gwiki:top}{}%
}

%% ----------------------------------------------------------------------------
%% THE ONE COMMAND: \wref
%% ----------------------------------------------------------------------------
%% Usage:
%%   \wref{note-name}                    -> Link to note.pdf, display "note-name"
%%   \wref[monoid]{monoid-in-monoidal}  -> Link, display "monoid" in prose
%%   \wref{note#sec:intro}               -> Link to note.pdf at named dest
%%   \wref{#sec:intro}                   -> Link within same document
%%
%% Links open the target PDF when clicked in a PDF viewer.

% Define a literal hash character for comparisons
\begingroup
\catcode`\#=12
\gdef\gwiki@hashchar{#}
\endgroup

\NewDocumentCommand{\wref}{O{} m o}{%
  % Allow display text either before or after the target argument
  \def\gwiki@display{#1}%
  \IfNoValueF{#3}{%
    \IfStrEq{#1}{}{%
      \def\gwiki@display{#3}%
    }{}%
  }%
  % Sanitize the input for xstring processing
  \edef\gwiki@safeinput{\detokenize{#2}}%
  % Check if it starts with # (internal reference)
  \IfBeginWith{\gwiki@safeinput}{\gwiki@hashchar}{%
    % Internal reference - strip the # and use hyperref
    % We use #2 directly here because hyperref handles it fine
    \StrBehind{#2}{\#}[\gwiki@intlabel]%
    \IfStrEq{\gwiki@display}{}{%
      \mbox{\hyperref[\gwiki@intlabel]{\gwiki@intlabel}}%
    }{%
      \mbox{\hyperref[\gwiki@intlabel]{\gwiki@display}}%
    }%
  }{%
    % Check if it contains # (cross-document section reference)
    \IfSubStr{\gwiki@safeinput}{\gwiki@hashchar}{%
      % We need to safely split the string.
      % xstring StrBefore/StrBehind might fail on raw #2 if it has #.
      % But actually, if we use the sanitized input for detection, we can just assume it's safe to
      % let xstring try on #2 if we double the hash? No, better to simply use \detokenize for splitting too.
      \StrBefore{\gwiki@safeinput}{\gwiki@hashchar}[\gwiki@xdoc]%
      \StrBehind{\gwiki@safeinput}{\gwiki@hashchar}[\gwiki@xlabel]%
      % Trim potential spaces from detokenization (optional but good practice)
      \IfStrEq{\gwiki@display}{}{%
        % Link to other PDF with named destination
        \mbox{\href{file:///Users/greysonwesley/Desktop/GWiki/pdfs/\gwiki@xdoc.pdf\#\gwiki@xlabel}{\textsl{\gwiki@xdoc} \S\gwiki@xlabel}}%
      }{%
        \mbox{\href{file:///Users/greysonwesley/Desktop/GWiki/pdfs/\gwiki@xdoc.pdf\#\gwiki@xlabel}{\gwiki@display}}%
      }%
    }{%
      % Simple document reference - link to PDF file
      \IfStrEq{\gwiki@display}{}{%
        \mbox{\href{file:///Users/greysonwesley/Desktop/GWiki/pdfs/#2.pdf}{#2}}%
      }{%
        \mbox{\href{file:///Users/greysonwesley/Desktop/GWiki/pdfs/#2.pdf}{\gwiki@display}}%
      }%
    }%
  }%
  % Record for backlinks (processed by build system)
  \IfBeginWith{\gwiki@safeinput}{\gwiki@hashchar}{}{%
    \IfSubStr{\gwiki@safeinput}{\gwiki@hashchar}{%
      \StrBefore{\gwiki@safeinput}{\gwiki@hashchar}[\gwiki@refdoc]%
      \immediate\write\@auxout{\string\gwiki@ref{\jobname}{\gwiki@refdoc}}%
    }{%
      \immediate\write\@auxout{\string\gwiki@ref{\jobname}{#2}}%
    }%
  }%
}

%% Dummy command for aux file (processed by scripts)
\newcommand{\gwiki@ref}[2]{}

%% ----------------------------------------------------------------------------
%% MULTI-FORMAT LINKS (PDF, HTML, MD)
%% ----------------------------------------------------------------------------

%% Read this note as PDF (local)
\newcommand{\aspdf}[1]{%
  \href{file:///Users/greysonwesley/Desktop/GWiki/pdfs/#1.pdf}{[PDF]}%
}

%% Read this note as HTML (local)
\newcommand{\ashtml}[1]{%
  \href{file:///Users/greysonwesley/Desktop/GWiki/html/#1.html}{[HTML]}%
}

%% Read this note in Obsidian (opens .md file)
\newcommand{\asmd}[1]{%
  \href{file:///Users/greysonwesley/Desktop/workflow/wiki/#1.md}{[MD]}%
}

%% All formats together
\newcommand{\allformats}[1]{%
  \aspdf{#1} \ashtml{#1} \asmd{#1}%
}

%% ----------------------------------------------------------------------------
%% SECTION LABELS FOR CROSS-REFERENCING
%% ----------------------------------------------------------------------------
%% Use standard \label for sections, then reference with \wref{doc#label}

%% Helper to create a cross-doc compatible label
\newcommand{\wlabel}[1]{\label{gwiki:\jobname:#1}\label{#1}}

%% ----------------------------------------------------------------------------
%% SIMPLE METADATA (optional)
%% ----------------------------------------------------------------------------
\newcommand{\gwiki@title}{}
\newcommand{\gwiki@tags}{}
\newcommand{\gwiki@aliases}{}
\newcommand{\gwiki@summary}{}
\newcommand{\gwiki@created}{}
\newcommand{\gwiki@manualmodified}{}
\newcommand{\gwiki@tagslist}{}
\newcommand{\gwiki@moddate}{}
\newcommand{\gwiki@modtime}{}
\newcommand{\gwiki@author}{Greyson Wesley}
\newcommand{\gwiki@keysources}{}
\newif\ifgwiki@keysourcespresent
\gwiki@keysourcespresentfalse
\newif\ifgwiki@keysourcesprinted
\gwiki@keysourcesprintedfalse
\newif\ifgwiki@headerprinted
\gwiki@headerprintedfalse
\providecommand{\gwiki@refslist}{}

% Default date formatter (user can \renewcommand)
\newcommand{\GWikiDateFormat}[2]{#1\space #2} % args: date, time
\newcommand{\CreatedOn}[1]{\renewcommand{\gwiki@created}{#1}}
\newcommand{\ModifiedOn}[1]{\renewcommand{\gwiki@manualmodified}{#1}}
\newcommand{\Author}[1]{\renewcommand{\gwiki@author}{#1}}

%% Set title
\newcommand{\Title}[1]{%
  \renewcommand{\gwiki@title}{#1}%
  \title{#1}%
  \hypersetup{pdftitle={#1}}%
}

%% Helper to collect tags from comma lists
\newcommand{\gwiki@addtags}[1]{%
  \foreach \t in {#1}{%
    \ifdefempty{\gwiki@tagslist}%
      {\global\edef\gwiki@tagslist{\t}}%
      {\global\edef\gwiki@tagslist{\gwiki@tagslist, \t}}%
  }%
}

%% Set tags (supports multiple braced args or comma lists)
\NewDocumentCommand{\Tags}{m +g +g +g +g}{%
  \renewcommand{\gwiki@tagslist}{}%
  \gwiki@addtags{#1}%
  \IfNoValueF{#2}{\gwiki@addtags{#2}}%
  \IfNoValueF{#3}{\gwiki@addtags{#3}}%
  \IfNoValueF{#4}{\gwiki@addtags{#4}}%
  \IfNoValueF{#5}{\gwiki@addtags{#5}}%
  \renewcommand{\gwiki@tags}{\gwiki@tagslist}%
}

%% Set aliases (comma-separated list)
\newcommand{\Aliases}[1]{\renewcommand{\gwiki@aliases}{#1}}

%% Set topics/summary
\newcommand{\Summary}[1]{\renewcommand{\gwiki@summary}{#1}}
\newcommand{\Topics}[1]{\renewcommand{\gwiki@summary}{#1}}

%% Write metadata to aux for indexing
\AtEndDocument{%
  \immediate\write\@auxout{\string\gwiki@meta{\jobname}{\gwiki@title}{\gwiki@tags}{\gwiki@aliases}}%
}
\newcommand{\gwiki@meta}[4]{}

%% ----------------------------------------------------------------------------
%% CROSS-FILE LABEL REFERENCES
%% ----------------------------------------------------------------------------
%% \wintref[display]{filename}{label} - Link to specific theorem/label in another file
%% Shows: [display/filename, ref-text] with clickable link to that location
%%
%% To enable full cross-document reference resolution, add to your document preamble:
%%   \externaldocument[filename-]{../build/pdf/filename}
%%
%% Example: \wintref[NT]{functor}{thm:yoneda} -> [NT, Theorem 2.1]
%%
%% Without \externaldocument, it shows: [NT, thm:yoneda] (label name as fallback)

\NewDocumentCommand{\wintref}{o m m}{%
  % #1 = optional display name (default: filename)
  % #2 = filename (without .pdf extension)
  % #3 = label name
  \def\wintref@display{#2}%
  \IfNoValueF{#1}{\def\wintref@display{#1}}%
  % Try to resolve the label reference
  % If \externaldocument was used, the label will be prefixed with filename-
  \def\wintref@labeltext{#3}%
  \@ifundefined{r@#2-#3}{%
    % Label not found - use label name as fallback
    \def\wintref@labeltext{#3}%
  }{%
    % Label found - use \ref to get the number
    \edef\wintref@labeltext{\ref*{#2-#3}}%
  }%
  % Create hyperlink to the specific label in the target PDF
  \mbox{[\href{file:///Users/greysonwesley/Desktop/GWiki/pdfs/#2.pdf\##3}{\wintref@display, \wintref@labeltext}]}%
}

%% ----------------------------------------------------------------------------
%% PREREQUISITES AND RELATED
%% ----------------------------------------------------------------------------
\newcommand{\prereq}[1]{%
  \noindent\textbf{Prerequisites:}~%
  \foreach \p in {#1} {\wref{\p}~}%
  \par\smallskip
}

\newcommand{\seealso}[1]{%
  \par\medskip\noindent\textbf{See also:}%
  \begin{itemize}[nosep,leftmargin=*]
    \foreach \p in {#1} {\item \wref{\p}}
  \end{itemize}
}

\newcommand{\SeeAlso}[1]{%
  \par\medskip\noindent\textbf{See also:}%
  \begin{itemize}[nosep,leftmargin=*]
    \foreach \p in {#1} {\item \wref{\p}}
  \end{itemize}
}

\newcommand{\IncomingLinks}[1]{%
  \par\medskip\noindent\textbf{Incoming links:}%
  \begin{itemize}[leftmargin=*]
    \foreach \p in {#1} {\item \wref{\p}}
  \end{itemize}
}

%% ----------------------------------------------------------------------------
%% SIMPLE HEADERS
%% ----------------------------------------------------------------------------
\newcount\gwiki@mincount
\newcommand{\gwiki@twodigits}[1]{\ifnum#1<10 0#1\else#1\fi}
\newcommand{\gwiki@capturefilemod}[7]{%
  \def\gwiki@modyear{#1}%
  \def\gwiki@modmonth{#2}%
  \def\gwiki@modday{#3}%
  \def\gwiki@modhour{#4}%
  \def\gwiki@modminute{#5}%
  \def\gwiki@modsecond{#6}%
  \def\gwiki@modzone{#7}%
}

\AtBeginDocument{%
  % Get modification date from file
  \filemodparse{\gwiki@capturefilemod}{\jobname.tex}%
  \gwiki@mincount=\gwiki@modminute\relax
  \divide\gwiki@mincount by 2
  \multiply\gwiki@mincount by 2
  \edef\gwiki@moddate{\gwiki@modyear-\gwiki@modmonth-\gwiki@modday}%
  \edef\gwiki@modtime{\gwiki@modhour:\gwiki@twodigits{\the\gwiki@mincount}}%
  \ifdefempty{\gwiki@modyear}{%
    \edef\gwiki@moddate{\DTMcurrenttime}%
    \edef\gwiki@modtime{\DTMcurrenttime}%
  }{}
  % Set creation date (check for injected date first)
  \ifdefempty{\gwiki@created}{%
    \ifdefined\gwikicreateddate
      \edef\gwiki@created{\gwikicreateddate}%
    \else
      \edef\gwiki@created{\gwiki@moddate}%
    \fi
  }{}
}

\newcommand{\gwiki@moddatestring}{%
  \ifdefempty{\gwiki@manualmodified}%
    {\GWikiDateFormat{\gwiki@moddate}{\gwiki@modtime}}%
    {\gwiki@manualmodified}%
}

%% Article header
\newcommand{\ArticleHeader}{%
  \thispagestyle{gwiki@first}%
  \maketitle
  \ifdefempty{\gwiki@summary}{}{\begin{abstract}\gwiki@summary\end{abstract}}
  {\hfill\small\color{gray!70}
    \ifdefempty{\gwiki@created}{}{Created: \gwiki@created\hfill}
    Last modified: \gwiki@moddatestring
    \ifdefempty{\gwiki@tags}{}{\hfill Tags: \gwiki@tags}
  }
}

%% Wiki note header
\newcommand{\NoteHeader}{%
  \thispagestyle{gwiki@first}%
  \gwiki@headerprintedtrue
  %
  % Title
  \noindent
  {\LARGE\bfseries\sffamily\color{blue!55!black}\gwiki@title\par}%
  \vspace{5pt}%
  %
  % Key sources line (if present)
  \gwiki@printkeysources
  %
  % Metadata line: tags, dates
  \noindent
  {\scriptsize\ttfamily\color{gray!55}%
    \ifdefempty{\gwiki@tags}{}{Tags: \gwiki@tags\quad|\quad}%
    Created \gwiki@created\quad|\quad%
    Modified \gwiki@moddatestring%
  \par}%
  \vspace{2pt}%
  %
  % Rule
  \noindent{\color{gray!25}\rule{\linewidth}{0.4pt}}\par%
  \vspace{6pt}%
  %
  % Topics (if present)
  \ifdefempty{\gwiki@summary}{}{\noindent\textbf{Topics.} \gwiki@summary\par\medskip}%
}

%% ----------------------------------------------------------------------------
%% IDEA + SOURCE BLOCKS
%% ----------------------------------------------------------------------------
\tcbset{
  gwikiIdeaBox/.style={
    enhanced,
    breakable,
    colback=cyan!3,
    colframe=cyan!40!black,
    boxrule=0.4pt,
    arc=0.8mm,
    left=6pt,
    right=6pt,
    top=4pt,
    bottom=4pt,
    borderline west={0.8pt}{0pt}{cyan!55!black},
    before skip=6pt,
    after skip=8pt,
  },
  gwikiKeySourceBox/.style={
    enhanced,
    breakable,
    colback=gray!3,
    colframe=gray!35,
    coltitle=gray!20!black,
    colbacktitle=gray!10,
    boxrule=0.35pt,
    arc=0.9mm,
    left=8pt,
    right=8pt,
    top=6pt,
    bottom=6pt,
    boxed title style={boxrule=0pt, colback=gray!10, sharp corners},
    fonttitle=\bfseries\sffamily,
    before skip=6pt,
    after skip=10pt,
  }
}

\newcommand{\gwiki@ideasuffix}{}
\NewDocumentEnvironment{framedidea}{o}{%
  \IfNoValueTF{#1}{\def\gwiki@ideasuffix{Idea}}{%
    \IfStrEq{#1}{Idea}{\def\gwiki@ideasuffix{Idea}}{\def\gwiki@ideasuffix{Idea: #1}}%
  }%
  \begin{tcolorbox}[gwikiIdeaBox]%
  \noindent\textbf{\gwiki@ideasuffix.}\space%
}{\end{tcolorbox}}

\NewDocumentEnvironment{idea}{o}{%
  \IfNoValueTF{#1}{\begin{framedidea}}{\begin{framedidea}[#1]}%
}{\end{framedidea}}

\NewDocumentCommand{\Idea}{O{} m}{%
  \IfNoValueTF{#1}{\begin{framedidea}}{\begin{framedidea}[#1]}%
  #2%
  \end{framedidea}%
}

%% Footer with metadata
\newcommand{\Footer}{%
  % Metadata is automatically shown in first page footer
  % This command now just marks the end of content
}

%% ----------------------------------------------------------------------------
%% REFERENCES (auto-collected)
%% ----------------------------------------------------------------------------
\providecommand{\gwiki@refslist}{}
\newcommand{\gwiki@addref}[1]{\gappto\gwiki@refslist{\unexpanded{#1}|}}

\newcommand{\gwiki@storekeysources}[1]{%
  \renewcommand{\gwiki@keysources}{#1}%
  \gwiki@keysourcespresenttrue
  \gwiki@keysourcesprintedfalse
}

\newcommand{\gwiki@printkeysources}{%
  \ifgwiki@keysourcesprinted\else
    \ifgwiki@keysourcespresent
      \forcsvlist{\gwiki@addref}{\gwiki@keysources}%
      \noindent{\footnotesize\color{gray!55}Key sources: \gwiki@keysources\par}%
      \vspace{2pt}%
      \global\gwiki@keysourcesprintedtrue
    \fi
  \fi
}

\let\KeySources\relax
\newcommand{\KeySources}[1]{%
  \gwiki@storekeysources{#1}%
  % Do not typeset anything where the command appears; the header will render it
  \ignorespaces
}

\newcommand{\arxiv}[1]{%
  \href{https://arxiv.org/abs/#1}{{\small\texttt{[arXiv:#1]}}}%
  \gwiki@addref{\href{https://arxiv.org/abs/#1}{\texttt{arXiv:#1}}}%
}

\newcommand{\nlab}[1]{%
  \href{https://ncatlab.org/nlab/show/#1}{\texttt{\textcolor{blue!60!black}{nLab:#1}}}%
  \gwiki@addref{\href{https://ncatlab.org/nlab/show/#1}{\texttt{nLab:#1}}}%
}

\newcommand{\References}{%
  \makeatletter
  \ifdefempty{\gwiki@refslist}{}{\relax
    \section*{References}
    \begin{itemize}[leftmargin=*]
      \forlistloop{\item}{\gwiki@refslist}
    \end{itemize}
  }%
  \makeatother
}

%% ----------------------------------------------------------------------------
%% SIMPLE INLINE CITES (lightweight, no .bib required)
%% ----------------------------------------------------------------------------
\NewDocumentCommand{\wcite}{o m}{%
  \textup{[}%
  \IfNoValueTF{#1}{#2}{#2, #1}%
  \textup{]}%
  \gwiki@addref{\IfNoValueTF{#1}{[#2]}{[#2, #1]}}%
}

%% ----------------------------------------------------------------------------
%% SERIES NAVIGATION
%% ----------------------------------------------------------------------------
\newcommand{\gwiki@prevnote}{}
\newcommand{\gwiki@nextnote}{}

\newcommand{\PreviousNote}[1]{\renewcommand{\gwiki@prevnote}{#1}}
\newcommand{\NextNote}[1]{\renewcommand{\gwiki@nextnote}{#1}}

\newcommand{\NoteNavigation}{%
  \ifboolexpr{ test {\ifdefempty{\gwiki@prevnote}} and test {\ifdefempty{\gwiki@nextnote}} }
  {}
  {
    \par\noindent\bigskip
    \begingroup\footnotesize
    \ifdefempty{\gwiki@prevnote}{}
      {\textbf{Previous:} \wref{\gwiki@prevnote}}%
    \ifdefempty{\gwiki@nextnote}{}
      {\hfill\textbf{Next:} \wref{\gwiki@nextnote}}%
    \endgroup
    \par\vspace{1em}
    \noindent{\color{gray!25}\rule{\linewidth}{0.4pt}}\par\vspace{1em}%
  }
}

\makeatother

\endinput
