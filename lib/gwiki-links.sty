\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gwiki-links}[2025/12/08 v3.0 GWiki Cross-Document PDF Linking]

%% ============================================================================
%% GWIKI LINKS v3 - CROSS-DOCUMENT PDF LINKING
%%
%% Design principles:
%%   - Filename = ID (no manual ID assignment)
%%   - Single \wref{name} command for everything
%%   - Links between separate PDFs using \href{file.pdf}
%%   - Click a link -> opens the other PDF
%% ============================================================================

\RequirePackage{xparse}
\RequirePackage{xstring}
\RequirePackage{hyperref}
\RequirePackage{pgffor}

%% ----------------------------------------------------------------------------
%% AUTO ID FROM FILENAME
%% ----------------------------------------------------------------------------
\newcommand{\gwiki@id}{\jobname}

%% Create anchor at document start (for internal refs)
\AtBeginDocument{%
  \hypertarget{gwiki:top}{}%
}

%% ----------------------------------------------------------------------------
%% THE ONE COMMAND: \wref
%% ----------------------------------------------------------------------------
%% Usage:
%%   \wref{note-name}                    -> Link to note.pdf, display "note-name"
%%   \wref[monoid]{monoid-in-monoidal}  -> Link, display "monoid" in prose
%%   \wref{note#sec:intro}               -> Link to note.pdf at named dest
%%   \wref{#sec:intro}                   -> Link within same document
%%
%% Links open the target PDF when clicked in a PDF viewer.

\NewDocumentCommand{\wref}{O{} m}{%
  % Check if it starts with # (internal reference)
  \IfBeginWith{#2}{\#}{%
    % Internal reference - strip the # and use hyperref
    \StrBehind{#2}{\#}[\gwiki@intlabel]%
    \IfStrEq{#1}{}{%
      \hyperref[\gwiki@intlabel]{\gwiki@intlabel}%
    }{%
      \hyperref[\gwiki@intlabel]{#1}%
    }%
  }{%
    % Check if it contains # (cross-document section reference)
    \IfSubStr{#2}{\#}{%
      \StrBefore{#2}{\#}[\gwiki@xdoc]%
      \StrBehind{#2}{\#}[\gwiki@xlabel]%
      \IfStrEq{#1}{}{%
        % Link to other PDF with named destination
        \href{run:./\gwiki@xdoc.pdf\#\gwiki@xlabel}{\textsl{\gwiki@xdoc} \S\gwiki@xlabel}%
      }{%
        \href{run:./\gwiki@xdoc.pdf\#\gwiki@xlabel}{#1}%
      }%
    }{%
      % Simple document reference - link to PDF file
      \IfStrEq{#1}{}{%
        \href{run:./#2.pdf}{\textsl{#2}}%
      }{%
        \href{run:./#2.pdf}{#1}%
      }%
    }%
  }%
  % Record for backlinks (processed by build system)
  \IfBeginWith{#2}{\#}{}{%
    \IfSubStr{#2}{\#}{%
      \StrBefore{#2}{\#}[\gwiki@refdoc]%
      \immediate\write\@auxout{\string\gwiki@ref{\jobname}{\gwiki@refdoc}}%
    }{%
      \immediate\write\@auxout{\string\gwiki@ref{\jobname}{#2}}%
    }%
  }%
}

%% Dummy command for aux file (processed by scripts)
\newcommand{\gwiki@ref}[2]{}

%% ----------------------------------------------------------------------------
%% SECTION LABELS FOR CROSS-REFERENCING
%% ----------------------------------------------------------------------------
%% Use standard \label for sections, then reference with \wref{doc#label}

%% Helper to create a cross-doc compatible label
\newcommand{\wlabel}[1]{\label{gwiki:\jobname:#1}\label{#1}}

%% ----------------------------------------------------------------------------
%% SIMPLE METADATA (optional)
%% ----------------------------------------------------------------------------
\newcommand{\gwiki@title}{}
\newcommand{\gwiki@tags}{}
\newcommand{\gwiki@summary}{}

%% Set title
\newcommand{\Title}[1]{%
  \renewcommand{\gwiki@title}{#1}%
  \title{#1}%
  \hypersetup{pdftitle={#1}}%
}

%% Set tags
\newcommand{\Tags}[1]{\renewcommand{\gwiki@tags}{#1}}

%% Set summary
\newcommand{\Summary}[1]{\renewcommand{\gwiki@summary}{#1}}

%% Write metadata to aux for indexing
\AtEndDocument{%
  \immediate\write\@auxout{\string\gwiki@meta{\jobname}{\gwiki@title}{\gwiki@tags}}%
}
\newcommand{\gwiki@meta}[3]{}

%% ----------------------------------------------------------------------------
%% PREREQUISITES AND RELATED
%% ----------------------------------------------------------------------------
\newcommand{\prereq}[1]{%
  \noindent\textbf{Prerequisites:}~%
  \foreach \p in {#1} {\wref{\p}~}%
  \par\smallskip
}

\newcommand{\seealso}[1]{%
  \par\medskip\noindent\textbf{See also:}~%
  \foreach \p in {#1} {\wref{\p}~}%
}

%% ----------------------------------------------------------------------------
%% SIMPLE HEADERS
%% ----------------------------------------------------------------------------

%% Article header
\newcommand{\ArticleHeader}{%
  \maketitle
  \ifx\gwiki@summary\empty\else
    \begin{abstract}\gwiki@summary\end{abstract}
  \fi
}

%% Wiki note header (minimal)
\newcommand{\NoteHeader}{%
  \noindent{\Large\bfseries\gwiki@title}%
  \par\smallskip
  \ifx\gwiki@summary\empty\else
    \noindent\textit{\gwiki@summary}\par\smallskip
  \fi
}

%% Footer with tags
\newcommand{\Footer}{%
  \ifx\gwiki@tags\empty\else
    \par\bigskip\noindent\textbf{Tags:}~\gwiki@tags
  \fi
}

%% ----------------------------------------------------------------------------
%% LEGACY COMPATIBILITY (maps old commands to new)
%% ----------------------------------------------------------------------------
\let\wikiref\wref
\let\articleref\wref
\newcommand{\GWikiMeta}[4]{\Title{#2}\Tags{#4}}
\let\gwikiarticleheader\ArticleHeader
\let\gwikinoteheader\NoteHeader
\let\gwikifooter\Footer

\endinput
